# Пайплайн выгрузки фотографий с телефона в дневник еды в Telegram

## Общая схема работы

1. **Импортируем фотографии с устройства (в формате HEIC) →**  
2. **Переименовываем файлы по дате создания →**  

```bash
./rename.sh in out
```

В процессе переименовывания используется дата создания файла из метаданных

3. **Конвертируем в JPEG с оптимизацией размера →**  

```bash
./heic_to_jpg.sh ./out ./jpg_out
```

В процессе конвертации также происходит downscaling фотографий, чтобы оптимизировать их загрузку по АПИ телеграма

4. **Запускаем скрипт отправки в Telegram →**  

```bash
docker run --rm -it \
   -v "$(pwd)":/app \
   -v ~/Downloads/diary/out:/photos telegram-photo-sender \
   python /app/send_photos.py /photos \
   BOT_TOKEN CHAT_ID
```

5. **Проверяем и подтверждаем отправку по датам →**  
6. **Фотографии аккуратно публикуются в канале с датой и в хронологическом порядке.**

## Подготовительные шаги

1. Сборка контейнера:

```bash
docker build -t telegram-photo-sender .
```

2. В Канал преварительно добавить заранее созданного бота (через BotFather). Там же взять его `BOT_TOKEN`.

3. После добавления отправить в канал тестовое сообщение и с помощью следующей команды узнать `CHAT_ID`:

```bash
curl "https://api.telegram.org/bot<BOT_TOKEN>/getUpdates"
```

## Итоговое резюме проекта: Автоматизация обработки и отправки фотографий в Telegram

### 1. Извлечение и переименование файлов с корректными датами из метаданных HEIC

**Что сделано:**  
- Написан bash-скрипт, который для каждого файла HEIC из исходной директории извлекает дату создания из EXIF-метаданных с помощью `exiftool`.  
- Файлы копируются в новую директорию с новым именем в формате:  
  `YYYY-MM-DDTHH:MM:SS_originalfilename.heic`  
- Если дата не найдена, используется константа `DATE_NA`.  
- Обрабатываются только файлы верхнего уровня, коллизии имён разрешаются перезаписью.

**Логика:**  
EXIF-метаданные содержат точную дату и время создания снимка, а не дату копирования. Это позволяет восстановить правильный хронологический порядок. Новое имя файла удобно для последующей группировки по дате.

---

### 2. Конвертация HEIC в JPEG с контролем качества и размера

**Что сделано:**  
- Bash-скрипт, использующий `ImageMagick` (`magick`), конвертирует HEIC в JPEG.  
- При конвертации задаётся качество JPEG (примерно 85%) для сжатия без сильной потери качества.  
- Опционально уменьшается максимальная ширина изображения (например, до 1920 px) для снижения размера файла.  
- Все JPEG-файлы сохраняются в отдельной директории.

**Логика:**  
Telegram плохо работает с HEIC как с фото, лучше отправлять JPEG. Контроль качества и размера позволяет уменьшить вес файлов для быстрой отправки и экономии трафика.

---

### 3. Скрипт на Python для группировки и отправки фотографий в Telegram

**Что сделано:**  
- Асинхронный Python-скрипт с использованием `python-telegram-bot` версии 20+.  
- На вход принимает путь к папке с JPEG, токен бота и chat_id канала.  
- Сканирует папку, группирует файлы по дате из имени (формат `YYYY-MM-DDTHH:MM:SS_...`).  
- Для каждой даты выводит в консоль приглашение к отправке.  
- При подтверждении пользователя отправляет все файлы за дату одним сообщением с подписью — дата выводится на русском (пример: "17 Июля").  
- Отправка реализована через `send_media_group`, где первый файл содержит подпись (caption), остальные — без подписи.  
- Файлы отправляются как фотографии (`InputMediaPhoto`), что позволяет видеть их в галерее Telegram.

**Логика:**  
Группировка по дате обеспечивает удобный хронологический просмотр. Запрос подтверждения даёт контроль пользователю. Отправка одной группой с подписью экономит пространство и делает сообщения аккуратными.

---

### 4. Docker-окружение для удобного запуска и разработки

**Что сделано:**  
- Создан Dockerfile с Python 3.11 и установленной библиотекой `python-telegram-bot`.  
- Для удобства разработки скрипт **не копируется в образ**, а монтируется из текущей папки, чтобы можно было менять код без пересборки образа.  
- Запуск контейнера с монтированием папки с фотографиями и текущей папки с кодом.  
- Добавлены рекомендации по запуску с интерактивным терминалом (`-it`), чтобы работать с запросом подтверждения.

**Логика:**  
Docker позволяет изолировать окружение, избавляет от необходимости устанавливать зависимости локально. Монтирование кода и данных обеспечивает быструю итерацию при разработке.
